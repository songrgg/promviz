graphName: Booking

dict: ./dict.json

globalLevel:
  #  maxVolume: 1200
  clusterConnections:
    - query: aliasSub(groupByNodes(perSecond(loadbalancers.group.{internal,external,integration,internalpci,externalpci,integrationpci,corporate}_*.*.haproxy.role.{book,bookadmin,app,b-payment-component-castle,b-payments-pay-notifications,xml_mobile,accounts_portal,xml_secure_mobile,xml_secure_distribution}.backend.*{bk-eu-west1-a,lhr4,fab4}*.{hrsp_2xx,hrsp_4xx,hrsp_5xx}),"sumSeries",9),".*hrsp_(.*)xx","INTERNET bk-eu-west1-a \1")
      prometheusURL: https://graphite-api.booking.com
      source:
        label: source
      target:
        label: target
      status:
        label: status
        warningRegex: ^4$
        dangerRegex: ^5$
    - query: aliasSub(groupByNodes(perSecond(loadbalancers.group.{internal,external,integration,internalpci,externalpci,integrationpci,corporate}_*.*.haproxy.role.{book,bookadmin,app,b-payment-component-castle,b-payments-pay-notifications,xml_mobile,accounts_portal,xml_secure_mobile,xml_secure_distribution}.backend.*{bk-eu-west2-a,ams4,ams30}*.{hrsp_2xx,hrsp_4xx,hrsp_5xx}),"sumSeries",9),".*hrsp_(.*)xx","INTERNET bk-eu-west2-a \1")
      prometheusURL: https://graphite-api.booking.com
      source:
        label: source
      target:
        label: target
      status:
        label: status
        warningRegex: ^4$
        dangerRegex: ^5$
    - query: aliasSub(groupByNodes(perSecond(loadbalancers.group.{internal,external,integration,internalpci,externalpci,integrationpci,corporate}_*.*.haproxy.role.{book,bookadmin,app,b-payment-component-castle,b-payments-pay-notifications,xml_mobile,accounts_portal,xml_secure_mobile,xml_secure_distribution}.backend.*{bk-eu-central1-a,ams4,ams30}*.{hrsp_2xx,hrsp_4xx,hrsp_5xx}),"sumSeries",9),".*hrsp_(.*)xx","INTERNET bk-eu-central1-a \1")
      prometheusURL: https://graphite-api.booking.com
      source:
        label: source
      target:
        label: target
      status:
        label: status
        warningRegex: ^4$
        dangerRegex: ^5$

clusterLevel:
  - cluster: bk-eu-west2-a
    maxVolume: 500000
    serviceConnections:
      - query: aliasSub(groupByNodes(perSecond(loadbalancers.group.{internal,external,integration,internalpci,externalpci,integrationpci,corporate}_*.*.haproxy.role.{book,bookadmin,app,b-payment-component-castle,b-payments-pay-notifications,xml_mobile,accounts_portal,xml_secure_mobile,xml_secure_distribution}.backend.*bk-eu-west2*.{hrsp_2xx,hrsp_4xx,hrsp_5xx}),"sumSeries",6,9),"(.*).hrsp_(.*)xx","INTERNET \1 \2")
        prometheusURL: https://graphite-api.booking.com
        source:
          label: source
        target:
          label: target
          translate: true
        status:
          label: status
          warningRegex: ^4$
          dangerRegex: ^5$
        notices:
          - name: HighErrorRate
            title: "[{{ .value }}] HighErrorRate"
            statusType: danger
            severityThreshold:
              warning: 0.01
              error: 0.01
      - query: aliasSub(scaleToSeconds(movingAverage(fallbackSeries(monitors.servicemesh.envoy.{bk-eu-west2-a,by_az.bk-eu-west2-a}.envoy_cluster_name.*{pay,vcc,bizent,point,wallet,finapi,cardstash,billing,fintooling}*.envoy_server_role.*.envoy_response_code_class.*.envoy_cluster_upstream_rq_xx.sum, constantLine(0)), '1m'), 1), ".*envoy_cluster_name.(.*).envoy_server_role.(.*).envoy_response_code_class.(.*).envoy_cluster_upstream_rq_xx.*", "\2 \1 \3")
        prometheusURL: https://graphite-api.booking.com
        source:
          label: source
          translate: true
        target:
          label: target
          translate: true
        status:
          label: status
          warningRegex: ^4$
          dangerRegex: ^5$
        notices:
          - name: HighErrorRate
            title: "[{{ .value }}] HighErrorRate"
            statusType: danger
            severityThreshold:
              warning: 0.01
              error: 0.01
      - query: aliasSub(scaleToSeconds(movingAverage(fallbackSeries(monitors.servicemesh.envoy.{bk-eu-west2-a,by_az.bk-eu-west2-a}.envoy_cluster_name.*.envoy_server_role.*{pay,vcc,bizent,point,wallet,finapi,cardstash,billing,fintooling}*.envoy_response_code_class.*.envoy_cluster_upstream_rq_xx.sum, constantLine(0)), '1m'), 1), ".*envoy_cluster_name.(.*).envoy_server_role.(.*).envoy_response_code_class.(.*).envoy_cluster_upstream_rq_xx.*", "\2 \1 \3")
        prometheusURL: https://graphite-api.booking.com
        source:
          label: source
          translate: true
        target:
          label: target
          translate: true
        status:
          label: status
          warningRegex: ^4$
          dangerRegex: ^5$
        notices:
          - name: HighErrorRate
            title: "[{{ .value }}] HighErrorRate"
            statusType: danger
            severityThreshold:
              warning: 0.01
              error: 0.01

  - cluster: bk-eu-west1-a
    maxVolume: 500000
    serviceConnections:
      - query: aliasSub(groupByNodes(perSecond(loadbalancers.group.{internal,external,integration,internalpci,externalpci,integrationpci,corporate}_*.*.haproxy.role.{book,bookadmin,app,b-payment-component-castle,b-payments-pay-notifications,xml_mobile,accounts_portal,xml_secure_mobile,xml_secure_distribution}.backend.*bk-eu-west2*.{hrsp_2xx,hrsp_4xx,hrsp_5xx}),"sumSeries",6,9),"(.*).hrsp_(.*)xx","INTERNET \1 \2")
        prometheusURL: https://graphite-api.booking.com
        source:
          label: source
        target:
          label: target
          translate: true
        status:
          label: status
          warningRegex: ^4$
          dangerRegex: ^5$
        notices:
          - name: HighErrorRate
            title: "[{{ .value }}] HighErrorRate"
            statusType: danger
            severityThreshold:
              warning: 0.01
              error: 0.01
      - query: aliasSub(scaleToSeconds(movingAverage(fallbackSeries(monitors.servicemesh.envoy.{bk-eu-west1-a,by_az.bk-eu-west1-a}.envoy_cluster_name.*{pay,vcc,bizent,point,wallet,finapi,cardstash,billing,fintooling}*.envoy_server_role.*.envoy_response_code_class.*.envoy_cluster_upstream_rq_xx.sum, constantLine(0)), '1m'), 1), ".*envoy_cluster_name.(.*).envoy_server_role.(.*).envoy_response_code_class.(.*).envoy_cluster_upstream_rq_xx.*", "\2 \1 \3")
        prometheusURL: https://graphite-api.booking.com
        source:
          label: source
          translate: true
        target:
          label: target
          translate: true
        status:
          label: status
          warningRegex: ^4$
          dangerRegex: ^5$
        notices:
          - name: HighErrorRate
            title: "[{{ .value }}] HighErrorRate"
            statusType: danger
            severityThreshold:
              warning: 0.01
              error: 0.01
      - query: aliasSub(scaleToSeconds(movingAverage(fallbackSeries(monitors.servicemesh.envoy.{bk-eu-west1-a,by_az.bk-eu-west1-a}.envoy_cluster_name.*.envoy_server_role.*{pay,vcc,bizent,point,wallet,finapi,cardstash,billing,fintooling}*.envoy_response_code_class.*.envoy_cluster_upstream_rq_xx.sum, constantLine(0)), '1m'), 1), ".*envoy_cluster_name.(.*).envoy_server_role.(.*).envoy_response_code_class.(.*).envoy_cluster_upstream_rq_xx.*", "\2 \1 \3")
        prometheusURL: https://graphite-api.booking.com
        source:
          label: source
          translate: true
        target:
          label: target
          translate: true
        status:
          label: status
          warningRegex: ^4$
          dangerRegex: ^5$
        notices:
          - name: HighErrorRate
            title: "[{{ .value }}] HighErrorRate"
            statusType: danger
            severityThreshold:
              warning: 0.01
              error: 0.01

  - cluster: bk-eu-central1-a
    maxVolume: 500000
    serviceConnections:
      - query: aliasSub(groupByNodes(perSecond(loadbalancers.group.{internal,external,integration,internalpci,externalpci,integrationpci,corporate}_*.*.haproxy.role.{book,bookadmin,app,b-payment-component-castle,b-payments-pay-notifications,xml_mobile,accounts_portal,xml_secure_mobile,xml_secure_distribution}.backend.*bk-eu-west2*.{hrsp_2xx,hrsp_4xx,hrsp_5xx}),"sumSeries",6,9),"(.*).hrsp_(.*)xx","INTERNET \1 \2")
        prometheusURL: https://graphite-api.booking.com
        source:
          label: source
        target:
          label: target
          translate: true
        status:
          label: status
          warningRegex: ^4$
          dangerRegex: ^5$
        notices:
          - name: HighErrorRate
            title: "[{{ .value }}] HighErrorRate"
            statusType: danger
            severityThreshold:
              warning: 0.01
              error: 0.01
      - query: aliasSub(scaleToSeconds(movingAverage(fallbackSeries(monitors.servicemesh.envoy.{bk-eu-central1-a,by_az.bk-eu-central1-a}.envoy_cluster_name.*{pay,vcc,bizent,point,wallet,finapi,cardstash,billing,fintooling}*.envoy_server_role.*.envoy_response_code_class.*.envoy_cluster_upstream_rq_xx.sum, constantLine(0)), '1m'), 1), ".*envoy_cluster_name.(.*).envoy_server_role.(.*).envoy_response_code_class.(.*).envoy_cluster_upstream_rq_xx.*", "\2 \1 \3")
        prometheusURL: https://graphite-api.booking.com
        source:
          label: source
          translate: true
        target:
          label: target
          translate: true
        status:
          label: status
          warningRegex: ^4$
          dangerRegex: ^5$
        notices:
          - name: HighErrorRate
            title: "[{{ .value }}] HighErrorRate"
            statusType: danger
            severityThreshold:
              warning: 0.01
              error: 0.01
      - query: aliasSub(scaleToSeconds(movingAverage(fallbackSeries(monitors.servicemesh.envoy.{bk-eu-central1-a,by_az.bk-eu-central1-a}.envoy_cluster_name.*.envoy_server_role.*{pay,vcc,bizent,point,wallet,finapi,cardstash,billing,fintooling}*.envoy_response_code_class.*.envoy_cluster_upstream_rq_xx.sum, constantLine(0)), '1m'), 1), ".*envoy_cluster_name.(.*).envoy_server_role.(.*).envoy_response_code_class.(.*).envoy_cluster_upstream_rq_xx.*", "\2 \1 \3")
        prometheusURL: https://graphite-api.booking.com
        source:
          label: source
          translate: true
        target:
          label: target
          translate: true
        status:
          label: status
          warningRegex: ^4$
          dangerRegex: ^5$
        notices:
          - name: HighErrorRate
            title: "[{{ .value }}] HighErrorRate"
            statusType: danger
            severityThreshold:
              warning: 0.01
              error: 0.01

classes:
  - name: http-server
    color: rgb(128, 128, 150)
  - name: grpc-server
    color: rgb(128, 128, 150)
  - name: redis
    color: rgb(150, 128, 128)
  - name: mongodb
    color: rgb(128, 150, 128)
